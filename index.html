<html>
<body>
	Public Key: <br>
	<textarea id="publicKey" length="2000"></textarea>
	<br> Private Key: <br>
	<textarea id="privateKey" length="2000"></textarea>
	<br> JWT Token: <br>
	<textarea id="jwtValue" length="2000"></textarea>
</body>

<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script type="text/javascript">
var publicKey = "not-set";
var privateKey = "not-set";	
generateKeyPair();
//<!--console.log("Action parameter = "+getParameter("action"));-->
var Uint8ArrayBuffer = {
  toUint8Array: function (str) {
      var chars = [];
      for (var i = 0; i < str.length; ++i) {
          chars.push(str.charCodeAt(i));
      }
      return new Uint8Array(chars);
  },
  toBase64: function(u8Arr){
    var CHUNK_SIZE = 0x8000; //arbitrary number
    var index = 0;
    var length = u8Arr.length;
    var result = '';
    var slice;
    while (index < length) {
      slice = u8Arr.subarray(index, Math.min(index + CHUNK_SIZE, length));
      result += String.fromCharCode.apply(null, slice);
      index += CHUNK_SIZE;
    }
    return window.btoa(result);
  }
};

function getParameter(name){
   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
}
function generateKeyPair() {
	var promise_key = null;
	var crypto = window.crypto;
	if(crypto.subtle)
	{
    promise_key = crypto.subtle.generateKey({name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([0x01, 0x00, 0x01]), hash: {name: "SHA-256"}}, false, ["encrypt", "decrypt"]);
    promise_key.then(function(keyPair){
      promise = window.crypto.subtle.exportKey('spki',keyPair.publicKey);
      promise.then(function(spki) {
        $("textarea#publicKey").val(Uint8ArrayBuffer.toBase64(new Uint8Array(spki)));
      });
      promise = window.crypto.subtle.exportKey('raw',keyPair.privateKey);
      promise.then(function(pkcs8) {
        $("textarea#privateKey").val(Uint8ArrayBuffer.toBase64(new Uint8Array(pkcs8)));
      });
      
    });
    promise_key.catch = function(e){
      console.log(e.message);
    }
  }
}

function generateJwtToken(privateKey, factorId, userId, domain, txId) {
  var timestamp = Math.floor(Date.now() / 1000);
  var payload = {
    iss: factorId,
    sub: userId,
    aud: domain,
    jti: timestamp, // not validated, should be UUID
    iat: timestamp,
    exp: (timestamp + (2 * 60)),
    nbf: (timestamp - (2 * 60)),
    tx: txId,
    result: 'APPROVE'
  };

  // header, typ is fixed value.
  var header = { typ: 'JWT', alg: 'RS256' };
  
  // create segments, all segment should be base64 string
  var segments = [];
  segments.push(Base64Url.encode(JSON.stringify(header)));
  segments.push(Base64Url.encode(JSON.stringify(payload)));

  return window.crypto.subtle.sign({
          name: "RSASSA-PKCS1-v1_5",
          hash: {name: "SHA-256"}
      },privateKey, Uint8ArrayBuffer.toUint8Array(segments.join('.')))
      .then(function(signature) {
        var base64 = Uint8ArrayBuffer.toBase64(new Uint8Array(signature));
        segments.push(Base64Url.escape(base64));
        return segments.join('.');
      })
      .then(function(jwt) {
        $("textarea#jwtValue").val(jwt);
      });
}
	
</script>
</html>
